<!doctype html><html lang=en><head><script type=text/javascript>window.location.hostname.indexOf("www")==0?window.location.replace(window.location.href.replace("www.","")):window.location.hostname.indexOf("blog")==0&&window.location.replace("https://alshakib.github.io/blog")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta id=theme-color name=theme-color content="#fafafa"><link rel=apple-touch-icon sizes=57x57 href=https://alshakib.github.io/images/fav/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://alshakib.github.io/images/fav/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://alshakib.github.io/images/fav/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://alshakib.github.io/images/fav/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://alshakib.github.io/images/fav/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://alshakib.github.io/images/fav/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://alshakib.github.io/images/fav/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://alshakib.github.io/images/fav/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=https://alshakib.github.io/images/fav/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=https://alshakib.github.io/images/fav/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=https://alshakib.github.io/images/fav/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=https://alshakib.github.io/images/fav/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=https://alshakib.github.io/images/fav/favicon-16x16.png><link rel=manifest href=fav/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="fav/ms-icon-144x144.png"><meta name=author content="Al Shakib"><meta name=description content="Fedora has been my primary operating system for many years. Recently I was doing some computation in the Google Compute Engine. I’ve been disappointed that there is no prebuilt image of Fedora in Google Compute Engine. But They provide a way to create custom images from source disks, images, snapshots, or images stored in Cloud Storage. We can use these images to create virtual machine (VM) instances. In this article we use Fedora Cloud Base Image to create the custom image for Google Compute Engine virtual machine instances."><meta name=keywords content="fedora,cloud,fedora 32,linux,google compute engine,google cloud,google cloud platform,gcp,how to,how to create custom image for google compute engine,how to create fedora custom image for google compute engine"><meta property="og:title" content="Create a Custom Image of Fedora Cloud for Google Compute Engine"><meta property="og:description" content="Fedora has been my primary operating system for many years. Recently I was doing some computation in the Google Compute Engine. I’ve been disappointed that there is no prebuilt image of Fedora in Google Compute Engine. But They provide a way to create custom images from source disks, images, snapshots, or images stored in Cloud Storage. We can use these images to create virtual machine (VM) instances. In this article we use Fedora Cloud Base Image to create the custom image for Google Compute Engine virtual machine instances."><meta property="og:type" content="article"><meta property="og:url" content="https://alshakib.github.io/blog/create-a-custom-image-of-fedora-cloud-for-gcp-09-09-2020/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-09-09T16:42:25+06:00"><meta property="article:modified_time" content="2020-09-09T16:42:25+06:00"><meta property="og:image" itemprop="image primaryImageOfPage" content="https://alshakib.github.io/images/fedora_cloud_32_for_gcp/featured_image.jpg"><meta property="og:image:secure_url" itemprop="image primaryImageOfPage" content="https://alshakib.github.io/images/fedora_cloud_32_for_gcp/featured_image.jpg"><meta name=twitter:card content="summary"><meta name=twitter:title content="Create a Custom Image of Fedora Cloud for Google Compute Engine"><meta name=twitter:description content="Fedora has been my primary operating system for many years. Recently I was doing some computation in the Google Compute Engine. I’ve been disappointed that there is no prebuilt image of Fedora in Google Compute Engine. But They provide a way to create custom images from source disks, images, snapshots, or images stored in Cloud Storage. We can use these images to create virtual machine (VM) instances. In this article we use Fedora Cloud Base Image to create the custom image for Google Compute Engine virtual machine instances."><meta property="twitter:image:src" content="https://alshakib.github.io/images/fedora_cloud_32_for_gcp/featured_image.jpg"><base href=https://alshakib.github.io/blog/create-a-custom-image-of-fedora-cloud-for-gcp-09-09-2020/><title>Create a Custom Image of Fedora Cloud for Google Compute Engine · Al Shakib</title><link rel=canonical href=https://alshakib.github.io/blog/create-a-custom-image-of-fedora-cloud-for-gcp-09-09-2020/><link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,600;0,800;1,600;1,800&family=Source+Code+Pro:ital,wght@0,600;0,700;1,600;1,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link id=light-css rel=stylesheet href=https://alshakib.github.io/css/alshakib.min.fef4aa0ff7d75a6364a16015b351091af80e6049cf51453774a6808eaee4bf8e.css integrity="sha256-/vSqD/fXWmNkoWAVs1EJGvgOYEnPUUU3dKaAjq7kv44=" crossorigin=anonymous media=screen><link id=light-syntax-highlight rel=stylesheet href=https://alshakib.github.io/css/friendly.css><link id=dark-css rel=stylesheet href=https://alshakib.github.io/css/alshakib-dark.min.b4fcd07d4dc7c9b2adc39edac400748abb4b18bc1b02ef697546bd6ac3681e86.css integrity="sha256-tPzQfU3HybKtw57axAB0irtLGLwbAu9pdUa9asNoHoY=" crossorigin=anonymous media=screen><link id=dark-syntax-highlight rel=stylesheet href=https://alshakib.github.io/css/native.css><script type=text/javascript>function setDarkTheme(){document.getElementById('dark-css').disabled=!1,document.getElementById('dark-syntax-highlight').disabled=!1,document.getElementById('theme-color').content='#15202b',localStorage.setItem('theme','dark')}function setLightTheme(){document.getElementById('dark-css').disabled=!0,document.getElementById('dark-syntax-highlight').disabled=!0,document.getElementById('theme-color').content='#fafafa',localStorage.setItem('theme','light')}function getTheme(){return localStorage.getItem('theme')}getTheme()=='dark'?setDarkTheme():getTheme()!='light'&&window.matchMedia('(prefers-color-scheme: dark)').matches?setDarkTheme():setLightTheme()</script><link rel=alternate type=application/rss+xml href=https://alshakib.dev/blog/index.xml title="Al Shakib's Blog"><script async src="https://www.googletagmanager.com/gtag/js?id=G-MM1547446W"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-MM1547446W')</script></head><body class=colorscheme-light><main class=wrapper><nav id=navbar class=navigation><section class=container><a class=navigation-title href=https://alshakib.github.io/>Home</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul id=navbar-list class=navigation-list><li class=navigation-item><a class=navigation-link href=https://alshakib.github.io/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://alshakib.github.io/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://alshakib.github.io/blog/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://alshakib.github.io/contact/>Contact</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><span onclick=onClickSwitchTheme()><i id=theme-icon class="fas fa-moon"></i></span></li></ul></section><button class=go-to-top onclick=onClickGoToTop() id=go-to-top-button title="Go to top">
<i class="fas fa-chevron-up"></i></button></nav><script type=text/javascript>var themeIcon=document.getElementById('theme-icon'),goToButton=document.getElementById('go-to-top-button'),navbar,navbarList;getTheme()=='dark'?themeIcon.className='fas fa-sun':themeIcon.className='fas fa-moon',navbar=document.getElementById('navbar'),navbarList=document.getElementById('navbar-list'),window.onscroll=function(){document.body.scrollTop>0||document.documentElement.scrollTop>0?(navbar.className='navigation is-scrolling',navbarList.className='navigation-list is-scrolling',goToButton.style.display='block'):(navbar.className='navigation',navbarList.className='navigation-list',goToButton.style.display='none')};function onClickSwitchTheme(){getTheme()=='dark'?(setLightTheme(),themeIcon.className='fas fa-moon'):(setDarkTheme(),themeIcon.className='fas fa-sun')}function onClickGoToTop(){document.body.scrollTop=0,document.documentElement.scrollTop=0}</script><div id=main-content class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Create a Custom Image of Fedora Cloud for Google Compute Engine</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar-alt"></i><time datetime=2020-09-09T16:42:25+06:00>September 9, 2020</time></span>
<span class=reading-time><i class="fas fa-clock"></i>5 min read</span></div><div class=categories><i class="fas fa-folder"></i><a href=https://alshakib.github.io/categories/linux/>Linux</a></div><div class=tags><i class="fas fa-tag"></i><a href=https://alshakib.github.io/tags/fedora/>Fedora</a>
<span class=separator>•</span>
<a href=https://alshakib.github.io/tags/google-compute-engine/>Google Compute Engine</a>
<span class=separator>•</span>
<a href=https://alshakib.github.io/tags/tutorial/>Tutorial</a></div></div></header><div><img src=https://alshakib.github.io/images/fedora_cloud_32_for_gcp/featured_image.jpg alt="Featured image"><aside><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#preparing-environment>Preparing environment</a></li><li><a href=#getting-started>Getting started</a></li><li><a href=#customizing-the-raw-image>Customizing the raw image</a></li><li><a href=#creating-the-custom-image-for-google-compute-engine>Creating the custom image for Google Compute Engine</a></li><li><a href=#testing>Testing</a></li><li><a href=#final-words>Final words</a></li></ul></nav></aside><h2 id=introduction>Introduction</h2><p>Fedora has been my primary operating system for many years. Recently I was doing some computation in the Google Compute Engine. In case you don’t know about Google Compute Engine, you can start from <a href=https://cloud.google.com/compute target=_blank>here</a>
. I’ve been disappointed that there is no prebuilt image of Fedora in Google Compute Engine. But they provide a way to create custom images from source disks, images, snapshots, or images stored in Cloud Storage. We can use these images to create virtual machine (VM) instances. In this article we use Fedora Cloud Base Image to create the custom image for Google Compute Engine virtual machine instances.</p><h2 id=preparing-environment>Preparing environment</h2><p>To start, you need a linux machine where we’re going to build and modify the official Fedora Cloud image for Google Compute Engine. You also need the gcloud command-line tool to upload and create the image from Google Cloud Storage Bucket. If you don’t have the gcloud command-line tool installed in your machine, you can install it from <a href=https://cloud.google.com/sdk/docs/quickstarts target=_blank>here</a>
.</p><p>After installing the gcloud command-line tool, use the <code>gcloud init</code> command to perform several common SDK setup tasks. These include authorizing the SDK tools to access Google Cloud using your user account credentials and setting up the default SDK configuration.</p><h2 id=getting-started>Getting started</h2><p>To create a custom image for Google Compute Engine, the first thing we will need is a Fedora Cloud Base Image. You can find a full list of Fedora Cloud Images <a href=https://alt.fedoraproject.org/cloud target=_blank>here</a>
. Among those, we download the Cloud Base compressed raw image. In this article, we use Fedora 32 Cloud Base Compressed Raw Image. To download the raw image, run,</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>wget <span class=s2>&#34;https://download.fedoraproject.org/pub/fedora/linux/releases/32/Cloud/x86_64/images/Fedora-Cloud-Base-32-1.6.x86_64.raw.xz&#34;</span>
</code></pre></div><p>Once download is done, decompress the downloaded file.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>xz --decompress <span class=s2>&#34;Fedora-Cloud-Base-32-1.6.x86_64.raw.xz&#34;</span>
</code></pre></div><p>This may take a few minutes to decompress. On the next step, we will mount this raw disk image, chroot inside it, install <code>google-compute-engine-tools</code> so it can be compatible with Google Compute Engine, remove a few unnecessary software, clean up various temporary files and then finally create a compressed disk image to upload on Google Cloud Storage.</p><h2 id=customizing-the-raw-image>Customizing the raw image</h2><p>First create an empty directory, where we can mount the raw disk image.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir <span class=s2>&#34;cloud&#34;</span>
</code></pre></div><p>And then mount the raw disk image to the <code>cloud</code> directory,</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo mount -o loop,offset<span class=o>=</span><span class=m>1048576</span> <span class=s2>&#34;</span><span class=nv>$PWD</span><span class=s2>/Fedora-Cloud-Base-32-1.6.x86_64.raw&#34;</span> <span class=s2>&#34;</span><span class=nv>$PWD</span><span class=s2>/cloud&#34;</span>
</code></pre></div><p>Change the current directory to the <code>cloud</code> directory and mount a few more directories for any decent application and network to work.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> <span class=s2>&#34;cloud&#34;</span>
sudo mount --bind <span class=s2>&#34;/dev&#34;</span> <span class=s2>&#34;dev&#34;</span> <span class=o>&amp;&amp;</span> sudo mount --bind <span class=s2>&#34;/sys&#34;</span> <span class=s2>&#34;sys&#34;</span> <span class=o>&amp;&amp;</span> sudo mount --bind <span class=s2>&#34;/proc&#34;</span> <span class=s2>&#34;proc&#34;</span> <span class=o>&amp;&amp;</span> sudo mount --bind <span class=s2>&#34;/etc/resolv.conf&#34;</span> <span class=s2>&#34;etc/resolv.conf&#34;</span>
</code></pre></div><p>Now, we can chroot to the mounted raw disk</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo chroot <span class=s2>&#34;./&#34;</span> <span class=s2>&#34;/usr/bin/bash&#34;</span>
</code></pre></div><p>You have successfully chroot to Fedora loop-mounted raw disk.
Let’s update the loop mounted system.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>dnf upgrade --assumeyes --nogpgcheck <span class=s2>&#34;*&#34;</span>
</code></pre></div><p>It may take a few minutes to complete. Once done, install <code>google-compute-engine-tools</code> and <code>cloud-utils-growpart</code> to make this image compatible with Google Compute Engine and resize the disk using <code>cloud-init</code>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>dnf install --assumeyes --nogpgcheck <span class=s2>&#34;google-compute-engine-tools&#34;</span> <span class=s2>&#34;cloud-utils-growpart&#34;</span>
</code></pre></div><p>This is going to install all Google Cloud related all softwares. Once installation is done, let’s enable a few systemd services to run on boot.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>systemctl <span class=nb>enable</span> <span class=s2>&#34;google-accounts-daemon&#34;</span> <span class=s2>&#34;google-clock-skew-daemon&#34;</span> <span class=se>\
</span><span class=se></span>    <span class=s2>&#34;google-instance-setup&#34;</span> <span class=s2>&#34;google-network-daemon&#34;</span> <span class=se>\
</span><span class=se></span>    <span class=s2>&#34;google-shutdown-scripts&#34;</span> <span class=s2>&#34;google-startup-scripts&#34;</span>
</code></pre></div><p>Since we installed and removed a few softwares, let’s relabel the entire file system on the next boot. We don’t want selinux to give us any headache.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>touch <span class=s2>&#34;/.autorelabel&#34;</span>
</code></pre></div><p>Now clean dnf caches, clear bash history, exit chroot and get out of the loop-mounted directory.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>dnf clean all
cat /dev/null &gt; /root/.bash_history <span class=o>&amp;&amp;</span> <span class=nb>history</span> -c <span class=o>&amp;&amp;</span> <span class=nb>exit</span>
<span class=nb>cd</span> ../
</code></pre></div><p>After getting out of the loop-mounted directory, you can unmount the directories.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo umount <span class=s2>&#34;cloud/dev&#34;</span> <span class=s2>&#34;cloud/proc&#34;</span> <span class=s2>&#34;cloud/sys&#34;</span> <span class=s2>&#34;cloud/etc/resolv.conf&#34;</span>
</code></pre></div><p>After that, remove temporary files and unmount the <code>cloud</code> directory.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo fstrim --verbose <span class=s2>&#34;cloud&#34;</span>
sudo umount <span class=s2>&#34;cloud&#34;</span>
</code></pre></div><p>Now it’s time to create the final image.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mv <span class=s2>&#34;Fedora-Cloud-Base-32-1.6.x86_64.raw&#34;</span> <span class=s2>&#34;disk.raw&#34;</span>
tar --create --auto-compress --file<span class=o>=</span><span class=s2>&#34;Fedora-Cloud-Base-32-1.6.x86_64.tar.gz&#34;</span> --sparse <span class=s2>&#34;disk.raw&#34;</span>
</code></pre></div><p>You have successfully created a custom compressed image that we are going to upload in the next step to the Google Cloud Bucket.</p><h2 id=creating-the-custom-image-for-google-compute-engine>Creating the custom image for Google Compute Engine</h2><p>Till now, we created a custom compressed image from Fedora Cloud Base raw image. Now we are going to create a Google Cloud Storage bucket and upload this compressed image to that storage bucket.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gsutil mb <span class=s2>&#34;gs://dev-al-shakib-custom-images&#34;</span>
</code></pre></div><p>This will create a Google Cloud Storage bucket as <code>dev-al-shakib-custom-images</code>. Please note that, you can pick only a globally unique name. So choose wisely. Once done, let’s upload our custom image to this bucket.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gsutil cp <span class=s2>&#34;Fedora-Cloud-Base-32-1.6.x86_64.tar.gz&#34;</span> <span class=s2>&#34;gs://dev-al-shakib-custom-images/&#34;</span>
</code></pre></div><p>This may take a few minutes. Once done, create a custom Google Compute Engine image from this uploaded compressed image.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gcloud compute images create --source-uri <span class=se>\
</span><span class=se></span>    gs://dev-al-shakib-custom-images/Fedora-Cloud-Base-32-1.6.x86_64.tar.gz <span class=se>\
</span><span class=se></span>    fedora-cloud-base-32
</code></pre></div><p>Congratulations! You have successfully created the Fedora Cloud Base 32 custom image.</p><h2 id=testing>Testing</h2><p>Now it’s time to test that custom image.</p><ol><li>Visit <a href=https://console.cloud.google.com/compute/instances target=_blank>here</a></li><li>Click on <code>Create Instance</code> button</li><li>Under the <code>Boot disk</code> section, click on the <code>Change</code> button.</li><li>Go in the <code>Custom images</code> tab and then pick the image you just created.</li><li>Change the boot disk size to 10GB.</li><li>You might want to set the VM as Preemptible, since you’ll use it only for tests and not keep it.</li><li>Click on the <code>Create</code> button.</li></ol><p>It may take a few minutes to boot up the instance. Once it’s up and running, click on the <code>SSH</code> button. Finally you’re logged in to your Fedora VM, run by Google Cloud Platform.</p><h2 id=final-words>Final words</h2><p>Thanks for reading this article. If you have any question or confusion regarding the tutorial, feel free to ask your questions on <a href=https://t.me/AlShakib target=_blank>Telegram</a>
or <a href=https://twitter.com/_alshakib target=_blank>Twitter</a>
. You can send me an email as well.</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2020 -
2021
Al Shakib</section></footer></main><script type=text/javascript>var menuToggleButton=document.getElementById('menu-toggle');document.getElementById('main-content').onclick=function(a){menuToggleButton.checked=!1}</script></body></html>